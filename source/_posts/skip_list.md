---
title: Redis跳表
date: 2020-12-12 22:30:10
tags: [Redis, 数据结构]
---

`跳表`在接触Redis以前，并没有听说过这个数据结构，从我的理解角度来看，跳表就是一个有序链表，但是在它的上面维护了多级索引，从而达到快速访问节点的目的。


## Redis中跳表示意图

Redis 的跳跃表由 redis.h/zskiplistNode 和 redis.h/zskiplist 两个结构定义， 其中 zskiplistNode 结构用于表示跳跃表节点， 而 zskiplist 结构则用于保存跳跃表节点的相关信息， 比如节点的数量， 以及指向表头节点和表尾节点的指针， 等等。

![一个跳跃表][/imgs/skiplist1.png]

上图展示了一个跳跃表实例，位于图片最左边的是skiplist结构，包含以下属性：

* header: 指向跳跃表的头节点
* tail: 指向跳跃表的尾节点
* level: 记录目前跳跃表内，层数最大的那个节点的层数（表头节点的层数不计算在内）
* length: 记录跳跃表的长度，即跳跃表目前包含节点的数量（表头节点不计算在内）

位于 zskiplist 结构右方的是四个 zskiplistNode 结构， 该结构包含以下属性：

* 层（level）：节点中用 L1 、 L2 、 L3 等字样标记节点的各个层， L1 代表第一层， L2 代表第二层，以此类推。每个层都带有两个属性：前进指针和跨度。前进指针用于访问位于表尾方向的其他节点，而跨度则记录了前进指针所指向节点和当前节点的距离。在上面的图片中，连线上带有数字的箭头就代表前进指针，而那个数字就是跨度。当程序从表头向表尾进行遍历时，访问会沿着层的前进指针进行。
* 后退（backward）指针：节点中用 BW 字样标记节点的后退指针，它指向位于当前节点的前一个节点。后退指针在程序从表尾向表头遍历时使用。
* 分值（score）：各个节点中的 1.0 、 2.0 和 3.0 是节点所保存的分值。在跳跃表中，节点按各自所保存的分值从小到大排列。
* 成员对象（obj）：各个节点中的 o1 、 o2 和 o3 是节点所保存的成员对象。

注意表头节点和其他节点的构造是一样的： 表头节点也有后退指针、分值和成员对象， 不过表头节点的这些属性都不会被用到， 所以图中省略了这些部分， 只显示了表头节点的各个层。

## Redis 为什么用跳表而不用红黑树来实现有序结合？

从Redis有序集合的功能来看，包含以下几个功能：
+ 插入元素
+ 删除元素
+ 查找元素
+ 有序输出所有元素
+ 查找区间内所有元素

前四项，红黑树和跳表时间复杂度一致，但是最后一项，红黑树效率相对就低了。
跳表只需要定位到两个区间端点所在最低层级的位置，然后顺序遍历元素即可。
红黑树在定位到端点后，从首位置开始每次都要查找后继节点，相对来说是比较耗时的。
另外一个原因，跳表实现起来相对更容易且易读。